<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stored Procedure Analysis | Dean&#39;s Blog</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Blog</a></li>
      
      <li><a href="/categories">Categories</a></li>
      
      <li><a href="/tags">Tags</a></li>
      
      <li><a href="/about">About</a></li>
      
      <li><a href="/blogroll">Blogroll</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Stored Procedure Analysis</span></h1>

<h2 class="date">2021/07/16</h2>
</div>

<main>
<h1 id="记录一次存储过程耗时分析">记录一次存储过程耗时分析</h1>
<p>公司某个项目的web数据库一些表经过了一些调整导致了一个主要核心业务的存储过程变得非常之慢，于是想要从存储过程中<br>
在一些关键性的地方打印出一些调试信息和时间信息，因为我们使用了RDS，所以没有办法将日志重定向到某个文件，因此<br>
我搜索了一下互联网，最终从stackoverflow中找到了一些思路，由于忘记保存书签了，没办法发到记录到这片博文中。</p>
<h2 id="主要思路">主要思路</h2>
<p>调试语句的主要思路就是创建一个零时的表例如debugMsg</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#719e07">DROP</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">IF</span> <span style="color:#719e07">EXISTS</span> <span style="color:#719e07">`</span>debugMsg<span style="color:#719e07">`</span>;
<span style="color:#719e07">CREATE</span> <span style="color:#719e07">TABLE</span> <span style="color:#719e07">`</span>debugMsg<span style="color:#719e07">`</span> (
  <span style="color:#719e07">`</span>msg<span style="color:#719e07">`</span> <span style="color:#b58900">varchar</span>(<span style="color:#2aa198">255</span>) <span style="color:#719e07">DEFAULT</span> <span style="color:#719e07">NULL</span>,
  <span style="color:#719e07">`</span>datetime<span style="color:#719e07">`</span> <span style="color:#b58900">int</span>(<span style="color:#2aa198">8</span>) <span style="color:#719e07">DEFAULT</span> <span style="color:#719e07">NULL</span>
) ENGINE<span style="color:#719e07">=</span>InnoDB <span style="color:#719e07">DEFAULT</span> CHARSET<span style="color:#719e07">=</span>utf8;
</code></pre></div><p>在我们执行特定语句的前后分别加入调试语句，将记录插入到debugMsg表中，已达到获取该段SQL执行时间的粗略时间,并且在存储过程最前加入一个标记位，方便开启关闭调试</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#719e07">set</span> <span style="color:#719e07">@</span>debug_enable<span style="color:#719e07">=</span><span style="color:#719e07">FALSE</span>;
<span style="color:#719e07">IF</span> <span style="color:#719e07">@</span>debug_enable <span style="color:#719e07">THEN</span>
	<span style="color:#719e07">delete</span> <span style="color:#719e07">from</span> debugMsg;
<span style="color:#719e07">END</span> <span style="color:#719e07">IF</span>;

...

<span style="color:#719e07">IF</span> <span style="color:#719e07">@</span>debug_enable <span style="color:#719e07">THEN</span>
	<span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> debugMsg(msg, datetime) <span style="color:#719e07">VALUES</span> (<span style="color:#2aa198">&#34;create case xxxxx....&#34;</span>, UNIX_TIMESTAMP());
<span style="color:#719e07">END</span> <span style="color:#719e07">IF</span>;
	业务代码部分


<span style="color:#719e07">IF</span> <span style="color:#719e07">@</span>debug_enable <span style="color:#719e07">THEN</span>
	<span style="color:#719e07">INSERT</span> <span style="color:#719e07">INTO</span> debugMsg(msg, datetime) <span style="color:#719e07">VALUES</span> (<span style="color:#2aa198">&#34;END create case xxxxx....&#34;</span>, UNIX_TIMESTAMP());
<span style="color:#719e07">END</span> <span style="color:#719e07">IF</span>;
</code></pre></div>
</main>
<hr />
<h1>Comments🎉</h1>

<div id="cusdis_thread"
  data-host="https://cusdis.com"
  data-app-id="5b549074-8206-4098-983b-d54bb541397a"
  data-page-id="a407407a84916891a20bbf4357cd72c2"
  data-page-url="https://treeboylife.com/blog/stored-procedure-analysis/"
  data-page-title="Stored Procedure Analysis"
></div>
<script async defer src="https://cusdis.com/js/cusdis.es.js"></script>
  <footer>
  
  
  <hr/>
  © <a href="https://treeboylife.com">Nan Dean</a> 2016 &ndash; 2021
  
  </footer>
  </body>
</html>

